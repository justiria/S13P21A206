# WebRTC P2P 구조의 부하 문제와 확장성 해결 방안

## 1. WebRTC의 P2P 구조 개요

**WebRTC (Web Real-Time Communication)**는 웹 브라우저 간 실시간 오디오, 비디오, 데이터 통신을 가능하게 하는 오픈소스 기술이다. 별도의 플러그인 없이도 브라우저끼리 직접 연결(Peer-to-Peer, P2P)하여 통신할 수 있도록 설계되었다.

### ✅ 기본 구성 요소
- **getUserMedia**: 사용자의 카메라 및 마이크에 접근
- **RTCPeerConnection**: 브라우저 간 미디어 스트림 전송
- **RTCDataChannel**: 실시간 텍스트/데이터 교환
- **시그널링(Signaling)**: 초기 연결 설정을 위한 별도 프로토콜(WebSocket 등)
- **ICE, STUN, TURN**: NAT 우회 및 IP 연결 설정을 위한 기술

이 구조는 **1:1 통화** 또는 **소규모 그룹(2~4인)**에 매우 적합하며, 중앙 서버 없이도 효율적인 실시간 통신이 가능하다.

---

## 2. P2P 메시 구조에서의 부하 문제

P2P 방식에서는 **모든 참가자가 서로 직접 연결**되며, 각 사용자끼리 **개별적으로 스트림을 주고받아야** 한다.  
이 구조는 참가자 수가 늘어날수록 다음과 같은 구조적 문제를 발생시킨다.

### ▶ 연결 수 증가
- 참가자 수를 **n**이라 할 때, 총 연결 수는 `n(n-1)` 또는 `nC2`에 가까움
- 예: 3명 → 6개 연결, 6명 → 30개 연결, 10명 → 90개 연결

### ▶ 업스트림 전송량 폭증
- 각 사용자는 **n-1명의 모든 참가자에게 업스트림 전송**을 해야 함
- 6명일 경우, 각 참가자는 5개의 비디오 스트림을 업로드해야 함
- 10명일 경우, 각 참가자는 9개의 업스트림을 동시에 송출

### ▶ 시스템 자원 소모
- **네트워크 대역폭**: 업스트림 사용량이 선형적으로 증가
- **CPU 부하**: 각 연결마다 개별 인코딩 수행 → CPU 사용량 급증
- **배터리 소모**: 클라이언트가 다수의 인코딩/디코딩을 수행해야 함

### ▶ 실제 문제 사례
- **Twilio**는 3~4명 이상의 영상 통화에서는 **P2P 품질 저하가 심각해진다**고 지적
- **Ant Media** 및 **Cloudflare**는 P2P 메시 방식이 **“확장성에 본질적 한계가 있다”**고 강조

---

## 3. P2P 구조의 확장성 한계

### 📌 적정 참가자 수
- **실무 권장 기준**:
  - 1:1 또는 최대 **3명 이하**: P2P 적합
  - 4명 이상: 지연, 품질 저하, 장치 과부하
  - 10명 이상: **사실상 실용적이지 않음**

### 📌 제한의 근본 원인
- 각 참가자가 **인코딩을 반복 수행**해야 하며,
- **다수의 병렬 연결**을 유지해야 함
- **비디오 품질 저하, 끊김 현상, 클라이언트 발열, 지연 발생**

### 📌 상용 서비스에서의 회피 전략
- Zoom, Google Meet, MS Teams 등은 **모두 P2P 구조를 사용하지 않음**
- **Twilio**도 4명 이상의 그룹 영상통화는 **Group Room (서버 중계 방식)** 사용을 권장

---

## 4. 확장성을 위한 미디어 서버 구조 (SFU / MCU)

P2P 구조의 확장 한계를 극복하기 위해, 실시간 미디어를 **중앙에서 처리 및 중계**하는 구조가 도입되었으며, 이를 **미디어 서버 구조**라고 한다.

### ✅ SFU (Selective Forwarding Unit)

- **기본 구조**: 모든 참가자가 **SFU 서버에 업스트림 1개**만 전송  
  → SFU 서버가 이를 다른 사용자에게 **선택적으로 포워딩**함
- **장점**:
  - 송출자와 시청자의 **네트워크 부담 감소**
  - 서버는 단순 라우팅만 수행 → **낮은 지연 시간**
  - 참가자 수 증가에도 **확장성 우수**
- **단점**:
  - 시청자는 다수의 다운스트림을 받을 수 있어 **클라이언트 부담은 있음**

#### ▶ 예시:
- 2명의 토론자 + 100명의 시청자
- 토론자는 SFU 서버에 1개의 스트림만 업로드
- 서버는 이를 100명에게 복제 전송 → 부하가 **송출자가 아닌 서버에 집중**

### ✅ MCU (Multipoint Control Unit)

- **기본 구조**: 모든 참가자의 스트림을 서버가 수신 → **디코딩 → 믹싱 → 재인코딩**  
  → **단일 통합 스트림**으로 모든 시청자에게 전송
- **장점**:
  - 시청자는 항상 1개의 스트림만 받으므로 **최소한의 리소스 사용**
- **단점**:
  - 서버에서 **인코딩 작업이 집중**되어 **비용과 지연이 큼**
  - 실시간성이 중요한 서비스에는 부적합

---

## 5. SFU / MCU 아키텍처 비교

| 항목              | P2P (Mesh)          | SFU                    | MCU                     |
|-------------------|---------------------|-------------------------|--------------------------|
| 구조              | 모든 참가자 간 직접 연결 | 스트림 포워딩 중계          | 믹싱 후 단일 스트림 전송       |
| 서버 부하         | 없음                | 중간 (라우팅만 수행)        | 매우 높음 (디코딩/인코딩)      |
| 클라이언트 부하     | 높음                | 중간                    | 낮음                    |
| 확장성            | 매우 낮음            | 매우 높음                | 낮음                    |
| 지연 시간          | 낮음 (소규모 기준)      | 낮음                    | 높음                    |
| 적합한 환경        | 2~3인 대화           | 토론, 방송, 세미나, 관전용   | 소규모 고품질 회의         |
| 실 서비스 적용     | 거의 없음            | Zoom, Jitsi, Ant Media 등 | 일부 기업용 시스템           |

---

## 6. 오픈소스 기반 미디어 서버 예시

### ✅ [Jitsi Videobridge](https://jitsi.org)
- 구조: SFU
- 특징: 설치 간단, 수천 명 동접 가능, 커뮤니티 활발
- 사용 예: Jitsi Meet, 학회, 커뮤니티 회의

### ✅ [Kurento Media Server](https://www.kurento.org)
- 구조: SFU + 일부 MCU 기능
- 특징: Java API 지원, 영상 처리 기능 포함 (필터, 컴퓨터 비전)
- 사용 예: 연구용, 커스텀 미디어 파이프라인 구축

### ✅ [Mediasoup](https://mediasoup.org)
- 구조: 고성능 SFU (C++ 기반)
- 특징: Node.js와 잘 통합됨, 낮은 지연, 상용급 확장성
- 사용 예: 상업용 라이브 방송 플랫폼, 커스터마이징 회의 시스템

### ✅ [Janus Gateway](https://janus.conf.meetecho.com/)
- 구조: 다기능 SFU
- 특징: 플러그인 기반 확장, 낮은 수준 API
- 사용 예: IoT, 음성 회의, 녹화, RTP 브릿징

---

## 7. 결론 및 실무 시사점

- WebRTC의 기본 P2P 구조는 소규모 통신에 적합하지만, **참관자가 많아지는 구조**(예: 2:N, 1:N 등)에서는 실용적이지 않음.
- **SFU/MCU 기반 미디어 서버** 도입은 WebRTC 시스템의 **확장성과 성능을 확보하는 핵심 요건**이다.
- 서비스 목적에 따라 아래와 같이 선택:
  - **5인 이하 소규모 팀 회의**: P2P 가능
  - **라이브 토론, 관전형 토크쇼, 강연**: SFU 권장
  - **고품질 화상회의(소수 대상)**: MCU도 고려

---

## 🔗 참고 출처

- [Twilio.com](https://www.twilio.com/docs/video)
- [Ant Media Server Blog](https://antmedia.io)
- [Cloudflare Blog](https://blog.cloudflare.com)
- [SWMansion WebRTC Guide](https://blog.swmansion.com)
- [Red5.net WebRTC Docs](https://www.red5.net)
- [Meetrix.io Jitsi Scaling](https://meetrix.io)