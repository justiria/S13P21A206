version: '3.8'

services:
  # Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ (ê¸°ì¡´ ìœ ì§€)
  app:
    build:
      context: .
      dockerfile: Dockerfile
    image: my-app:latest
    ports:
      - "127.0.0.1:8081:8080"
    env_file:
      - .env
    environment:
      SPRING_DATASOURCE_URL: "${DB_URL}"
      SPRING_DATASOURCE_USERNAME: "${DB_USERNAME}"
      SPRING_DATASOURCE_PASSWORD: "${DB_PASSWORD}"
      SPRING_JWT_SECRET: "${JWT_SECRET_KEY}"
      AWS_ACCESS_KEY_ID: "${AWS_ACCESS_KEY_ID}"
      AWS_SECRET_ACCESS_KEY: "${AWS_SECRET_ACCESS_KEY}"
      S3_BUCKET_NAME: "${S3_BUCKET_NAME}"
      # LiveKit í™˜ê²½ë³€ìˆ˜ ì¶”ê°€
      LIVEKIT_API_KEY: "${LIVEKIT_API_KEY:-devkey}"
      LIVEKIT_API_SECRET: "${LIVEKIT_API_SECRET:-secret}"
      # ì‹œê°„ëŒ€ ì„¤ì • ì¶”ê°€
      TZ: Asia/Seoul
    restart: always

  # ìˆœìˆ˜ LiveKit ì„œë²„ (ì¹œêµ¬ ë°©ì‹)
  livekit:
    image: livekit/livekit-server:latest
    container_name: livekit
    restart: unless-stopped
    environment:
      LIVEKIT_KEYS: "devkey: secret"
      LIVEKIT_CONFIG: |
        rtc:
          udp_port: 8882
          tcp_port: 8881
        webhook:
          api_key: devkey
          urls:
            - http://host.docker.internal:8081/calls/livekit/webhook
    command:
      - --bind=0.0.0.0
      - --node-ip=3.35.17.1  # ğŸ”‘ í•µì‹¬ ì„¤ì •!
      - --port=8880
    ports:
      - "127.0.0.1:8880:8880"   # ì‹œê·¸ë„ë§ (Nginxê°€ ì´ í¬íŠ¸ë¡œ í”„ë¡ì‹œ)
      - "8881:8881"             # TCP RTC
      - "8882:8882/udp"         # UDP RTC