<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    <title>Chat Test - TEXT Only</title>
</head>
<body>
<h2>1:1 Chat Test (TEXT Only)</h2>

<!-- ì…ë ¥ ì˜ì—­ -->
<div>
    <label>Sender ID: </label>
    <input id="senderId" placeholder="senderId ì…ë ¥" value="1"/>
</div>
<div>
    <label>Couple ID: </label>
    <input id="coupleId" placeholder="coupleId ì…ë ¥" value="1"/>
</div>

<div style="margin-top:8px;">
    <button id="connectBtn">Connect</button>
</div>

<!-- ì±„íŒ… ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ -->
<div id="messages" style="border:1px solid #ccc; padding:10px; height:200px; width:300px; overflow:auto; margin-top:16px;">
</div>

<!-- í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡ -->
<div style="margin-top:8px;">
    <input id="msgInput" placeholder="ë©”ì‹œì§€ ì…ë ¥" style="width:220px;"/>
    <button id="sendBtn">Send</button>
</div>

<!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ -->
<script>
    let stompClient;

    // WebSocket ì—°ê²°
    document.getElementById('connectBtn').onclick = () => {
        const coupleId = parseInt(document.getElementById('coupleId').value.trim(), 10);
        if (!coupleId) return alert('Couple IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

        const socket = new SockJS('/api/v1/ws-chat');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, frame => {
            console.log('âœ… Connected:', frame);
            document.getElementById('messages').innerHTML = '';

            // coupleId ê¸°ë°˜ êµ¬ë…
            stompClient.subscribe(`/sub/chat/${coupleId}`, msg => {
                console.log("ğŸ“© ë°›ì€ ë©”ì‹œì§€:", msg.body);
                const chat = JSON.parse(msg.body);
                const div = document.createElement('div');
                div.textContent = `[${chat.sentAt}] ${chat.senderId}: ${chat.content}`;
                document.getElementById('messages').appendChild(div);
                document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
            });
        }, error => {
            console.error('âŒ WebSocket error', error);
            alert('WebSocket ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        });
    };

    // í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡
    document.getElementById('sendBtn').onclick = () => {
        if (!stompClient) return alert('ë¨¼ì € Connect ë²„íŠ¼ì„ ëˆŒëŸ¬ ì—°ê²°í•˜ì„¸ìš”.');

        const coupleId = parseInt(document.getElementById('coupleId').value.trim(), 10);
        const senderId = parseInt(document.getElementById('senderId').value.trim(), 10);
        const content  = document.getElementById('msgInput').value.trim();

        if (!content) return alert('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

        const payload = {
            coupleId: coupleId,
            senderId: senderId,
            content: content,
            messageType: "TEXT"
        };

        stompClient.send('/pub/chat/sendMessage', {}, JSON.stringify(payload));
        document.getElementById('msgInput').value = '';
    };
</script>
</body>
</html>
