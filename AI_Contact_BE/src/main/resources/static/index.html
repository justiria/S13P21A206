<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>AI Baby Chat 테스트</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #chat { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; }
        .msg { margin: 5px 0; }
        .user { color: blue; }
        .ai   { color: green; }
    </style>
</head>
<body>
<h2>AI 아기 채팅 테스트</h2>

<div>
    <label>Couple ID:
        <input type="number" id="coupleId" value="1" style="width:60px;" />
    </label>
    <label>User ID:
        <input type="text" id="userId"   value="user1" style="width:100px;" />
    </label>
    <button id="connectBtn">연결</button>
</div>

<div id="chat"></div>
<div style="margin-top:10px;">
    <input type="text" id="messageInput" placeholder="메시지를 입력하세요" style="width:300px;" />
    <button id="sendBtn">보내기</button>
</div>

<script>
    let stompClient;
    let currentCouple;

    // 서버 컨텍스트 경로가 /api/v1 이면 여기에 붙여주세요
    const contextPath = '/api/v1';

    document.getElementById('connectBtn').onclick = () => {
        if (stompClient) {
            stompClient.disconnect();
            document.getElementById('chat').innerHTML = '';
        }
        currentCouple = document.getElementById('coupleId').value;
        const socket = new SockJS(contextPath + '/ws-baby');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, () => {
            stompClient.subscribe('/topic/baby/' + currentCouple, msg => {
                const body = JSON.parse(msg.body);
                const div = document.createElement('div');
                div.className = 'msg ' + (body.sender === 'ai-baby' ? 'ai' : 'user');
                div.textContent = body.sender + ': ' + body.message;
                document.getElementById('chat').appendChild(div);
                document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
            });
        });
    };

    document.getElementById('sendBtn').onclick = () => {
        if (!stompClient || stompClient.disconnecting) {
            alert('먼저 연결 버튼을 눌러주세요');
            return;
        }
        const userId = document.getElementById('userId').value;
        const text   = document.getElementById('messageInput').value;
        if (!text) return;
        const payload = JSON.stringify({ sender: userId, message: text });
        stompClient.send('/app/baby/' + currentCouple, {}, payload);
        document.getElementById('messageInput').value = '';
    };
</script>
</body>
</html>
